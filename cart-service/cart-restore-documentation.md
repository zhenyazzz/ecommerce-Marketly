# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ PostgreSQL + Redis

## üèóÔ∏è –ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: PostgreSQL + Redis

### **–°—Ö–µ–º–∞ —Ä–∞–±–æ—Ç—ã:**
```
PostgreSQL (–æ—Å–Ω–æ–≤–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ) ‚Üê‚Üí Redis (–∫–µ—à –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞)
```

### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- **PostgreSQL**: –ù–∞–¥–µ–∂–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ, —Å–ª–æ–∂–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
- **Redis**: –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –∞–∫—Ç–∏–≤–Ω—ã–º –∫–æ—Ä–∑–∏–Ω–∞–º, —Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î

---

## üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã

### **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:**
1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–æ—Ä–∑–∏–Ω—É
2. –ö–æ—Ä–∑–∏–Ω–∞ –±—ã–ª–∞ –æ—á–∏—â–µ–Ω–∞ –ø–æ—Å–ª–µ –∑–∞–∫–∞–∑–∞
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–∫—É–ø–∫—É

### **API Endpoint:**
```http
POST /api/carts/restore
Header: X-User-Id: 1
```

### **–õ–æ–≥–∏–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:**
```java
// 1. –ù–∞–π—Ç–∏ –∞—Ä—Ö–∏–≤–Ω—ã–µ –∫–æ—Ä–∑–∏–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
List<Cart> archivedCarts = cartRepository.findByUserIdAndStatusIn(
    userId, List.of(CartStatus.ARCHIVED, CartStatus.CONVERTED_TO_ORDER));

// 2. –í–∑—è—Ç—å —Å–∞–º—É—é –ø–æ—Å–ª–µ–¥–Ω—é—é
Cart lastCart = archivedCarts.get(0);

// 3. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ—Ä–∑–∏–Ω—É —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π
Cart newCart = Cart.builder()
    .userId(userId)
    .cartItems(new ArrayList<>(lastCart.getCartItems()))
    .total(lastCart.getTotal())
    .status(CartStatus.ACTIVE)
    .build();

// 4. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î –∏ –æ–±–Ω–æ–≤–∏—Ç—å –∫–µ—à
```

---

## üìä –ü—Ä–∏–º–µ—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

### **–°—Ü–µ–Ω–∞—Ä–∏–π 1: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∑–∞–∫–∞–∑–∞**
```
–î–µ–Ω—å 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏–ª iPhone ‚Üí ACTIVE –∫–æ—Ä–∑–∏–Ω–∞
–î–µ–Ω—å 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∫—É–ø–∏–ª iPhone ‚Üí ARCHIVED –∫–æ—Ä–∑–∏–Ω–∞ + –Ω–æ–≤–∞—è ACTIVE (–ø—É—Å—Ç–∞—è)
–î–µ–Ω—å 3: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –∫—É–ø–∏—Ç—å –µ—â–µ iPhone ‚Üí –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ—Ä–∑–∏–Ω—É
–†–µ–∑—É–ª—å—Ç–∞—Ç: ACTIVE –∫–æ—Ä–∑–∏–Ω–∞ —Å iPhone
```

### **–°—Ü–µ–Ω–∞—Ä–∏–π 2: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±—Ä–æ—à–µ–Ω–Ω–æ–π –∫–æ—Ä–∑–∏–Ω—ã**
```
–î–µ–Ω—å 1: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–∏–ª —Ç–æ–≤–∞—Ä—ã ‚Üí ACTIVE –∫–æ—Ä–∑–∏–Ω–∞
–î–µ–Ω—å 2: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∫—É–ø–∏–ª ‚Üí ABANDONED –∫–æ—Ä–∑–∏–Ω–∞
–î–µ–Ω—å 3: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –∫—É–ø–∏—Ç—å ‚Üí –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ—Ä–∑–∏–Ω—É
–†–µ–∑—É–ª—å—Ç–∞—Ç: ACTIVE –∫–æ—Ä–∑–∏–Ω–∞ —Å —Ç–æ–≤–∞—Ä–∞–º–∏
```

---

## üöÄ –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Redis

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–µ—à–∞:**
```redis
cart:1 ‚Üí CartResponse (–∞–∫—Ç–∏–≤–Ω–∞—è –∫–æ—Ä–∑–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 1)
cart:2 ‚Üí CartResponse (–∞–∫—Ç–∏–≤–Ω–∞—è –∫–æ—Ä–∑–∏–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 2)
```

### **TTL –∫–µ—à–∞:**
- **24 —á–∞—Å–∞** - –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –∏ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å—é
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã
- **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞

### **–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è:**
```java
// –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
public CartResponse getCart(Long userId) {
    // 1. –ü—Ä–æ–±—É–µ–º –∫–µ—à
    return cartCacheService.getCachedCart(userId)
        .orElseGet(() -> {
            // 2. –ï—Å–ª–∏ –Ω–µ—Ç –≤ –∫–µ—à–µ, –ø–æ–ª—É—á–∞–µ–º –∏–∑ –ë–î
            Cart cart = getActiveCartOrThrow(userId);
            CartResponse response = CartMapper.toCartResponse(cart);
            
            // 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à
            cartCacheService.cacheCart(userId, response);
            
            return response;
        });
}
```

---

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### **–ë–µ–∑ –∫–µ—à–∞:**
```
–ó–∞–ø—Ä–æ—Å –∫–æ—Ä–∑–∏–Ω—ã ‚Üí PostgreSQL ‚Üí ~10-50ms
```

### **–° –∫–µ—à–µ–º:**
```
–ó–∞–ø—Ä–æ—Å –∫–æ—Ä–∑–∏–Ω—ã ‚Üí Redis ‚Üí ~1-5ms (95% —Å–ª—É—á–∞–µ–≤)
–ó–∞–ø—Ä–æ—Å –∫–æ—Ä–∑–∏–Ω—ã ‚Üí PostgreSQL ‚Üí ~10-50ms (5% —Å–ª—É—á–∞–µ–≤)
```

### **–£–ª—É—á—à–µ–Ω–∏–µ:**
- **–í 10-50 —Ä–∞–∑ –±—ã—Å—Ç—Ä–µ–µ** –¥–ª—è –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏** –Ω–∞ PostgreSQL –Ω–∞ 80-90%
- **–õ—É—á—à–∏–π UX** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

---

## üõ†Ô∏è API Endpoints

### **–û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:**
```http
GET    /api/carts              # –ü–æ–ª—É—á–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—É—é –∫–æ—Ä–∑–∏–Ω—É (—Å –∫–µ—à–µ–º)
POST   /api/carts/items        # –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
DELETE /api/carts/items/{id}   # –£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä
DELETE /api/carts              # –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
```

### **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏ –∏—Å—Ç–æ—Ä–∏—è:**
```http
GET    /api/carts/history      # –ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö –∫–æ—Ä–∑–∏–Ω
POST   /api/carts/restore      # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–æ—Ä–∑–∏–Ω—É
POST   /api/carts/convert-to-order  # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ –∑–∞–∫–∞–∑
```

---

## üîç –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∫–µ—à–∞

### **–ú–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:**
```java
// Hit rate (–ø—Ä–æ—Ü–µ–Ω—Ç –ø–æ–ø–∞–¥–∞–Ω–∏–π –≤ –∫–µ—à)
double hitRate = cacheHits / (cacheHits + cacheMisses);

// –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞
double avgResponseTime = totalResponseTime / totalRequests;

// –†–∞–∑–º–µ—Ä –∫–µ—à–∞
long cacheSize = redisTemplate.keys("cart:*").size();
```

### **–ê–ª–µ—Ä—Ç—ã:**
- Hit rate < 80% ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–µ—à–∞
- Response time > 100ms ‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å PostgreSQL
- Cache size > 10000 ‚Üí –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

### **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∫–µ—à–∞:**
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ** –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ—Ä–∑–∏–Ω—ã
- **–ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞
- **Graceful degradation** –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Redis

### **–ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö:**
- **PostgreSQL** - –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã
- **Redis** - —Ç–æ–ª—å–∫–æ –∫–µ—à
- **–ü—Ä–∏ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–∏** - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç PostgreSQL

### **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:**
```java
try {
    // –ü–æ–ø—ã—Ç–∫–∞ –∫–µ—à–∞
    return cartCacheService.getCachedCart(userId);
} catch (Exception e) {
    log.warn("Cache failed, falling back to database");
    // Fallback –∫ –ë–î
    return getCartFromDatabase(userId);
}
```

---

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã:**
1. **–í—ã—Å–æ–∫–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - Redis –∫–µ—à
2. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - PostgreSQL —Ö—Ä–∞–Ω–µ–Ω–∏–µ
3. **–ì–∏–±–∫–æ—Å—Ç—å** - –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ—Ä–∑–∏–Ω
4. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- **–ë—ã—Å—Ç—Ä—ã–µ –æ—Ç–≤–µ—Ç—ã** –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **–ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è** –∫–æ—Ä–∑–∏–Ω
- **–ü—Ä–æ—Å—Ç–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ** –ø–æ–∫—É–ø–æ–∫
- **–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å** e-commerce 